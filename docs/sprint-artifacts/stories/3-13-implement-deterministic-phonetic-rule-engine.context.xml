<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>13</storyId>
    <title>Implement Deterministic Norwegian Phonetic Rule Engine</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-13-implement-deterministic-phonetic-rule-engine.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user creating Norwegian songs</asA>
    <iWant>lyrics to be phonetically optimized using consistent, predictable rules</iWant>
    <soThat>AI-generated vocals pronounce Norwegian words authentically without relying on GPT-4 API calls</soThat>
    <tasks>
      <task id="1" title="Create new deterministic rule engine" acs="1,2,3">
        <subtask id="1.1">Create src/lib/phonetic/rule-engine.ts with 6 transformation functions</subtask>
        <subtask id="1.2">Implement Silent D removal with "død" context detection</subtask>
        <subtask id="1.3">Implement ND→NN pattern transformation</subtask>
        <subtask id="1.4">Implement RD→R pattern transformation</subtask>
        <subtask id="1.5">Implement OG→Å replacement</subtask>
        <subtask id="1.6">Implement acronym expansion with Norwegian alphabet</subtask>
        <subtask id="1.7">Create src/lib/phonetic/number-converter.ts with full algorithmic number-to-words conversion</subtask>
        <subtask id="1.8">Add proper noun preservation logic</subtask>
      </task>
      <task id="2" title="Replace GPT-4 optimizer" acs="4,7">
        <subtask id="2.1">Update src/lib/phonetic/optimizer.ts to use rule engine instead of GPT-4</subtask>
        <subtask id="2.2">Remove OpenAI import and API call logic</subtask>
        <subtask id="2.3">Update /api/lyrics/optimize/route.ts to use new optimizer</subtask>
        <subtask id="2.4">Keep existing PhoneticChange interface for compatibility</subtask>
      </task>
      <task id="3" title="Update rules cache" acs="1">
        <subtask id="3.1">Update src/lib/phonetic/rules.ts - remove rolling R transformations</subtask>
        <subtask id="3.2">Remove conflicting cache entries (rød→rrrød, etc.)</subtask>
        <subtask id="3.3">Keep preserved words list</subtask>
      </task>
      <task id="4" title="Testing and validation" acs="5,6,8">
        <subtask id="4.1">Create test file with all 10 v3.0 test cases</subtask>
        <subtask id="4.2">Verify phonetic diff viewer works with new changes</subtask>
        <subtask id="4.3">Verify performance less than 100ms</subtask>
        <subtask id="4.4">Manual test in UI with sample lyrics</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Rule engine applies 6 transformation rules in exact order: Silent D removal, ND→NN, RD→R, OG→Å, Acronym expansion, Number expansion</criterion>
    <criterion id="2">"død" context detection works correctly - adjective use removes D, noun use keeps D</criterion>
    <criterion id="3">Proper nouns preserved (Oslo, Bergen, Trondheim remain unchanged)</criterion>
    <criterion id="4">GPT-4 API calls removed from phonetic optimization flow</criterion>
    <criterion id="5">All 10 test cases from v3.0 rules document pass</criterion>
    <criterion id="6">Phonetic diff viewer continues to work with new rule engine</criterion>
    <criterion id="7">Existing /api/lyrics/optimize endpoint uses new rule engine</criterion>
    <criterion id="8">Performance improvement: optimization completes in less than 100ms</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/norwegian-phonetic-rules.md</path>
        <title>Norwegian Bokmål Phonetic Transformation Rules</title>
        <section>Complete v3.0 ruleset</section>
        <snippet>6 transformation rules with test cases: Silent D, ND→NN, RD→R, OG→Å, Acronyms, Numbers. Includes year conversion (2001-2009 = to-tusen-å-X) and proper noun preservation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Musikkfabrikken Architecture</title>
        <section>ADR-006: Norwegian Pronunciation Optimization via GPT-4</section>
        <snippet>Original decision to use GPT-4 for phonetic optimization. This story supersedes ADR-006 with deterministic rule engine.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>Technical Specification</title>
        <section>Project Stack</section>
        <snippet>Next.js 14.2.3, TypeScript, Tailwind CSS, Supabase. Component pattern uses 'use client', kebab-case files, PascalCase components.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/lib/phonetic/optimizer.ts</path>
        <kind>service</kind>
        <symbol>optimizeLyrics, validateOptimization</symbol>
        <lines>1-221</lines>
        <reason>Main optimizer to refactor - replace GPT-4 call with rule engine</reason>
      </file>
      <file>
        <path>src/lib/phonetic/rules.ts</path>
        <kind>config</kind>
        <symbol>phoneticCache, preservedWords, getCachedPhonetic, applyCachedRules</symbol>
        <lines>1-210</lines>
        <reason>Current cache with rolling R rules to remove, preserved words to keep</reason>
      </file>
      <file>
        <path>src/lib/phonetic/diff.ts</path>
        <kind>utility</kind>
        <symbol>computeDiff, mergeLyrics, DiffLine, DiffSegment</symbol>
        <lines>1-137</lines>
        <reason>Diff algorithm used by PhoneticDiffViewer - must continue to work with new PhoneticChange format</reason>
      </file>
      <file>
        <path>src/app/api/lyrics/optimize/route.ts</path>
        <kind>api-route</kind>
        <symbol>POST handler</symbol>
        <lines>1-139</lines>
        <reason>API endpoint that calls optimizeLyrics - may need timeout adjustment for faster rule engine</reason>
      </file>
      <file>
        <path>src/components/phonetic-diff-viewer.tsx</path>
        <kind>component</kind>
        <symbol>PhoneticDiffViewer</symbol>
        <lines>1-227</lines>
        <reason>UI component consuming PhoneticChange - verify compatibility after optimizer changes</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package name="next" version="^14.2.3">React framework with App Router</package>
        <package name="react" version="^18.2.0">UI library</package>
        <package name="typescript" version="^5">Type checking</package>
        <package name="openai" version="^6.9.1">To be removed from phonetic optimizer</package>
        <package name="zod" version="^4.1.12">Schema validation</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Replace GPT-4 with deterministic rules - no AI API calls in optimization flow</constraint>
    <constraint type="performance">Optimization must complete in less than 100ms (currently 1-3s with GPT-4)</constraint>
    <constraint type="compatibility">Keep PhoneticChange interface unchanged for backwards compatibility with diff viewer</constraint>
    <constraint type="language">All error messages in Norwegian (Bokmål)</constraint>
    <constraint type="pattern">Follow existing file naming: kebab-case.ts for utilities</constraint>
    <constraint type="rule-order">Apply 6 rules in exact sequence: Silent D, ND→NN, RD→R, OG→Å, Acronyms, Numbers</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PhoneticChange</name>
      <kind>TypeScript interface</kind>
      <signature>{ original: string; optimized: string; reason: string; lineNumber: number }</signature>
      <path>src/lib/phonetic/optimizer.ts</path>
    </interface>
    <interface>
      <name>OptimizationResult</name>
      <kind>TypeScript interface</kind>
      <signature>{ originalLyrics: string; optimizedLyrics: string; changes: PhoneticChange[]; cacheHitRate: number }</signature>
      <path>src/lib/phonetic/optimizer.ts</path>
    </interface>
    <interface>
      <name>POST /api/lyrics/optimize</name>
      <kind>REST endpoint</kind>
      <signature>Request: { lyrics: string } Response: { data: OptimizationResult } or { error: { code, message } }</signature>
      <path>src/app/api/lyrics/optimize/route.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>No test framework currently configured. Manual testing via UI and Vercel preview deploys. For this story, create a test file that can be run with ts-node or as part of build verification.</standards>
    <locations>
      <location>src/lib/phonetic/*.test.ts (new)</location>
    </locations>
    <ideas>
      <idea ac="1">Test all 6 transformation rules individually with known input/output pairs</idea>
      <idea ac="2">Test "død" context detection: "er død" → "er dø", "mye død" → "mye død"</idea>
      <idea ac="3">Test proper noun preservation: "I Oslo ved fjord" → "I Oslo ve fjor"</idea>
      <idea ac="5">Run all 10 test cases from v3.0 document</idea>
      <idea ac="6">Verify PhoneticDiffViewer renders correctly with new rule engine output</idea>
      <idea ac="8">Measure execution time - must be less than 100ms for typical lyrics</idea>
    </ideas>
  </tests>
</story-context>
